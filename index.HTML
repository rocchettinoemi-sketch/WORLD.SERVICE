<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WORLD SERVICE</title>

<style>
body{
 font-family:'Segoe UI',Tahoma;
 margin:0;
 background:
 linear-gradient(rgba(255,255,255,.94),rgba(255,255,255,.94)),
 url("https://images.unsplash.com/photo-1503387762-592deb58ef4e");
 background-size:cover;
 min-height:100vh;
}

header{
 text-align:center;
 padding:10px;
 background:#ffffffdd;
 box-shadow:0 2px 4px rgba(0,0,0,.1)
}

header img{height:50px}

.card{
 background:#fff;
 padding:16px;
 margin:10px auto;
 border-radius:12px;
 width:95%;
 max-width:420px;
 box-shadow:0 4px 12px rgba(0,0,0,.12)
}

.hidden{display:none}

button,input,select{
 width:100%;
 padding:12px;
 margin:6px 0;
 border-radius:8px;
 border:1px solid #ccc;
 font-size:16px
}

.green{background:#4CAF50;color:#fff}
.blue{background:#2196F3;color:#fff}
.gray{background:#9E9E9E;color:#fff}
.orange{background:#ff9800;color:#fff}
.red{background:#f44336;color:#fff}
.purple{background:#3f51b5;color:#fff}

.homeBtn{
 position:fixed;
 bottom:12px;
 right:12px;
 width:45px;
 height:45px;
 border-radius:50%;
 border:none;
 background:#4CAF50;
 color:#fff;
 font-size:18px;
 box-shadow:0 3px 8px rgba(0,0,0,.3)
}
</style>
</head>
<body>

<header>
<img src="https://worldservice.it/wp-content/uploads/2020/05/logo2_400.png">
</header>

<div class="card hidden" id="scanCard">
<h3>Scansiona o inserisci targa</h3>
<input id="targaManuale" placeholder="Targa">
<input id="kmInizio" type="number" placeholder="KM iniziali">
<button class="blue" onclick="avviaMezzo()">AVVIA MEZZO</button>
<button class="gray" onclick="apriPresenza()">OGGI NON USO IL MEZZO</button>
</div>

<div class="card hidden" id="menuCard">
<select id="comune">
<option value="">Seleziona comune</option>
<option>VESCOVATO</option>
<option>BONEMERSE</option>
</select>

<button id="btnTrasbordo" class="gray" onclick="apriTrasbordo()">TRASBORDO</button>
<button id="btnImpianto" class="blue" onclick="apriImpianto()">SCARICO IMPIANTO</button>

<button class="purple" onclick="fineServizio()">FINE SERVIZIO</button>
</div>

<div class="card hidden" id="trasbordoCard">
<input id="kmScarico" type="number" placeholder="KM scarico">
<button class="green" onclick="salvaTrasbordo()">SALVA</button>
</div>

<div class="card hidden" id="impiantoCard">
<select id="cer">
<option>20 01 08 Umido</option>
<option>20 01 01 Carta</option>
<option>20 01 02 Vetro</option>
<option>20 01 39 Plastica</option>
<option>20 03 01 Indifferenziato</option>
</select>
<input id="peso" placeholder="Peso (kg)">
<input id="kmImp" type="number" placeholder="KM">
<button class="green" onclick="salvaImpianto()">SALVA</button>
</div>

<button class="homeBtn" onclick="init()">üè†</button>

<script>
const API_URL="https://script.google.com/macros/s/AKfycbwUkkkDCMAY_JPoDw8Nm7T0dcD1Bt5mukGif5ScshnY3ekpgwMqHzBhYcrF539oTr7m/exec";

function send(data){
 fetch(API_URL,{
  method:"POST",
  body:JSON.stringify(data)
 });
}

function hideAll(){
 document.querySelectorAll('.card').forEach(c=>c.classList.add('hidden'));
}

function init(){
 hideAll();
 let mezzo=JSON.parse(localStorage.getItem("mezzo"));
 if(mezzo && mezzo.attivo){
   menuCard.classList.remove("hidden");
 }else{
   scanCard.classList.remove("hidden");
 }
}

document.addEventListener("DOMContentLoaded",init);

async function avviaMezzo(){
 if(!targaManuale.value||!kmInizio.value) return alert("Compila dati");

 let mezzo={
  targa:targaManuale.value.toUpperCase(),
  kmInizio:kmInizio.value,
  attivo:true
 };

 localStorage.setItem("mezzo",JSON.stringify(mezzo));

 send({
  sheet:"MEZZI",
  row:[
   new Date().toLocaleString(),
   mezzo.targa,
   "",
   mezzo.kmInizio,
   "",
   ""
  ]
 });

 targaManuale.value="";
 kmInizio.value="";
 init();
}

function apriTrasbordo(){hideAll();trasbordoCard.classList.remove("hidden");}

function salvaTrasbordo(){
 let mezzo=JSON.parse(localStorage.getItem("mezzo"));
 send({
  sheet:"SCARICHI",
  row:[
   new Date().toLocaleString(),
   "TRASBORDO",
   comune.value,
   "",
   kmScarico.value,
   "",
   ""
  ]
 });

 kmScarico.value="";
 init();
}

function apriImpianto(){hideAll();impiantoCard.classList.remove("hidden");}

function salvaImpianto(){
 send({
  sheet:"SCARICHI",
  row:[
   new Date().toLocaleString(),
   "IMPIANTO",
   comune.value,
   cer.value,
   kmImp.value,
   peso.value,
   ""
  ]
 });

 cer.selectedIndex=0;
 peso.value="";
 kmImp.value="";
 init();
}

function fineServizio(){
 let mezzo=JSON.parse(localStorage.getItem("mezzo"));
 if(!mezzo) return;

 let kmFinali=prompt("Inserisci KM finali");
 if(!kmFinali) return alert("KM obbligatori");

 send({
  sheet:"MEZZI",
  row:[
   new Date().toLocaleString(),
   mezzo.targa,
   "",
   "",
   kmFinali,
   ""
  ]
 });

 localStorage.removeItem("mezzo");
 init();
}
</script>
</body>
</html>